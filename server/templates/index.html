<!DOCTYPE html>
<html lang="ru" x-data="validationApp()" class="bg-slate-100 min-h-screen">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Валидация истории остатков</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="flex items-center justify-center py-12">
    <div class="w-full max-w-3xl">
        <div class="bg-white shadow-xl rounded-2xl p-8 space-y-8">
            <header class="space-y-2 text-center">
                <h1 class="text-3xl font-semibold text-slate-800">Сбор валидационного инпута</h1>
                <p class="text-slate-500">Загрузите файлы «История остатков … .xlsx», затем соберите Excel для проверки данных.</p>
            </header>

            <section>
                <div
                    class="border-2 border-dashed border-slate-300 rounded-xl bg-slate-50 p-8 text-center transition hover:border-indigo-400 hover:bg-indigo-50 cursor-pointer"
                    @click="chooseFiles"
                    @dragover.prevent
                    @dragenter.prevent="dragActive = true"
                    @dragleave.prevent="dragActive = false"
                    @drop.prevent="handleDrop($event)"
                    :class="{'border-indigo-500 bg-indigo-50': dragActive}"
                >
                    <div class="space-y-3">
                        <div class="flex justify-center">
                            <span class="inline-flex h-16 w-16 items-center justify-center rounded-full bg-indigo-100 text-indigo-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M7.5 12 12 7.5m0 0L16.5 12M12 7.5V18" />
                                </svg>
                            </span>
                        </div>
                        <p class="text-lg font-medium text-slate-700">Перетащите сюда файлы или нажмите для выбора</p>
                        <p class="text-sm text-slate-500">Поддерживаются .xlsx, .xls, .csv</p>
                    </div>
                    <input type="file" multiple accept=".xlsx,.xls,.csv" class="hidden" x-ref="fileInput" @change="handleSelect($event)">
                </div>
                <template x-if="files.length">
                    <ul class="mt-4 space-y-2">
                        <template x-for="file in files" :key="file.name + file.size">
                            <li class="flex items-center justify-between rounded-lg bg-slate-100 px-4 py-2 text-sm text-slate-600">
                                <span x-text="file.name"></span>
                                <span x-text="formatSize(file.size)"></span>
                            </li>
                        </template>
                    </ul>
                </template>
            </section>

            <section class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                <button
                    class="flex-1 rounded-xl bg-indigo-600 px-5 py-3 text-center text-base font-medium text-white shadow-md transition hover:bg-indigo-700 disabled:cursor-not-allowed disabled:bg-slate-300"
                    @click="submit"
                    :disabled="loading || !files.length"
                >
                    <span x-show="!loading">Собрать валидационный инпут</span>
                    <span x-show="loading" class="flex items-center justify-center gap-2">
                        <svg class="h-5 w-5 animate-spin" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 0 1 8-8v4a4 4 0 0 0-4 4H4z"></path>
                        </svg>
                        Обработка...
                    </span>
                </button>
                <a
                    class="flex-1 rounded-xl border border-indigo-500 px-5 py-3 text-center text-base font-medium text-indigo-600 transition hover:bg-indigo-50 disabled:pointer-events-none disabled:border-slate-300 disabled:text-slate-400"
                    :class="{'opacity-50': !downloadToken}"
                    :href="downloadLink"
                    @click.prevent="download($event)"
                >
                    Скачать Excel
                </a>
            </section>

            <section class="rounded-xl bg-slate-50 p-4">
                <h2 class="text-lg font-semibold text-slate-700">Лог обработки</h2>
                <div class="mt-3 max-h-56 overflow-y-auto rounded-lg bg-white p-4 text-sm text-slate-600">
                    <template x-if="!log.length">
                        <p class="text-slate-400">Здесь появится ход обработки после запуска.</p>
                    </template>
                    <template x-for="(line, index) in log" :key="index">
                        <p class="whitespace-pre-wrap" x-text="line"></p>
                    </template>
                </div>
                <template x-if="error">
                    <p class="mt-2 text-sm text-red-500" x-text="error"></p>
                </template>
            </section>
        </div>
    </div>

    <script>
        function validationApp() {
            return {
                files: [],
                dragActive: false,
                loading: false,
                log: [],
                error: '',
                downloadToken: null,
                get downloadLink() {
                    if (!this.downloadToken) {
                        return '#';
                    }
                    return `/download/${this.downloadToken}`;
                },
                chooseFiles() {
                    this.$refs.fileInput.click();
                },
                handleSelect(event) {
                    this.files = Array.from(event.target.files);
                },
                handleDrop(event) {
                    this.dragActive = false;
                    const droppedFiles = event.dataTransfer.files;
                    this.files = Array.from(droppedFiles);
                },
                formatSize(size) {
                    if (size < 1024) {
                        return `${size} Б`;
                    }
                    if (size < 1024 * 1024) {
                        return `${(size / 1024).toFixed(1)} КБ`;
                    }
                    return `${(size / (1024 * 1024)).toFixed(1)} МБ`;
                },
                async submit() {
                    if (!this.files.length || this.loading) {
                        return;
                    }
                    this.loading = true;
                    this.error = '';
                    this.log = [];
                    this.downloadToken = null;

                    const formData = new FormData();
                    this.files.forEach((file) => formData.append('files', file));

                    try {
                        const response = await fetch('/build', {
                            method: 'POST',
                            body: formData,
                        });

                        const data = await response.json();

                        if (!response.ok || !data.ok) {
                            this.error = data.detail || 'Не удалось обработать файлы';
                            this.log = data.log || [];
                            return;
                        }

                        this.log = data.log || [];
                        this.downloadToken = data.download_token || null;
                    } catch (err) {
                        this.error = 'Сервис недоступен. Попробуйте позже.';
                    } finally {
                        this.loading = false;
                    }
                },
                download(event) {
                    if (!this.downloadToken) {
                        event.preventDefault();
                        return;
                    }
                    window.open(this.downloadLink, '_blank');
                },
            };
        }
    </script>
</body>
</html>
