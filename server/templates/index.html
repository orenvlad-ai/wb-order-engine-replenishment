<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–°–±–æ—Ä –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∏–Ω–ø—É—Ç–∞</title>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100">
  <div class="max-w-3xl mx-auto p-6">
    <div class="bg-white shadow rounded-2xl p-6" x-data="ui()">
      <h1 class="text-2xl font-bold mb-4">–°–±–æ—Ä –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –∏–Ω–ø—É—Ç–∞</h1>
      <p class="text-slate-600 text-sm mb-3">
        –ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ—Ç—á—ë—Ç—ã:
        <br>‚Ä¢ <span class="font-medium">–ò—Å—Ç–æ—Ä–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤</span>
        <br>‚Ä¢ <span class="font-medium">–û—Å—Ç–∞—Ç–∫–∏ –§—É–ª—Ñ–∏–ª–º–µ–Ω—Ç</span> (—à–∞–±–ª–æ–Ω –Ω–∏–∂–µ)
        <br>‚Ä¢ <span class="font-medium">–ü–æ—Å—Ç–∞–≤–∫–∏ –≤ –ø—É—Ç–∏</span> (–æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –ø–æ –∫–∞–∂–¥–æ–º—É —Å–∫–ª–∞–¥—É)
      </p>
      <form @submit.prevent="build()">
        <label for="files" class="flex flex-col items-center justify-center w-full h-40 border-2 border-dashed rounded-xl text-slate-500 mb-3"
               @dragover.prevent
               @drop.prevent="onDrop($event)">
          <input type="file" id="files" name="files" multiple class="hidden" accept=".xlsx,.csv" @change="onPick">
          <div class="text-center cursor-pointer">
            <div class="text-4xl">‚¨ÜÔ∏è</div>
            <div>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ —Ñ–∞–π–ª—ã –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
            <div class="text-xs">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è .xlsx, .csv</div>
          </div>
        </label>
        <div class="mb-4" x-show="files.length">
          <div class="text-sm text-slate-600 mb-1">
            –í—ã–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: <b x-text="files.length"></b>
            <button type="button" class="ml-2 text-red-600 underline" @click="clearAll">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
          <ul class="space-y-1 max-h-40 overflow-auto border rounded-lg p-2 bg-slate-50">
            <template x-for="(f, idx) in files" :key="idx">
              <li class="flex items-center justify-between text-sm">
                <span x-text="formatName(f)"></span>
                <button type="button" class="text-slate-500 hover:text-red-600" @click="remove(idx)">‚úï</button>
              </li>
            </template>
          </ul>
        </div>

        <div class="flex gap-3 flex-wrap">
          <button type="button"
                  class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700"
                  @click="build()">
            –°–æ–±—Ä–∞—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω—ã–π –∏–Ω–ø—É—Ç
          </button>
          <a :class="{'opacity-50 pointer-events-none': !token}" :href="token ? '/download/'+token : '#'"
             class="px-4 py-2 rounded-lg border border-indigo-600 text-indigo-700">–°–∫–∞—á–∞—Ç—å Excel</a>

          <button type="button"
                  class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700"
                  @click="recommend()">
            –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏
          </button>
          <a :class="{'opacity-50 pointer-events-none': !reco_token}" :href="reco_token ? '/download/'+reco_token : '#'"
             class="px-4 py-2 rounded-lg border border-slate-400 text-slate-700">
            –°–∫–∞—á–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
          </a>
        </div>

        <div class="mt-6 border-t pt-4">
          <h3 class="text-lg font-semibold mb-2">üìÑ –®–∞–±–ª–æ–Ω—ã –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤</h3>
          <ul class="list-disc list-inside text-sm text-slate-700">
            <li>
              <a href="/download/fulfillment_template.xlsx" class="text-green-700 hover:underline">
                –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω ¬´–û—Å—Ç–∞—Ç–∫–∏ –§—É–ª—Ñ–∏–ª–º–µ–Ω—Ç¬ª
              </a>
            </li>
          </ul>
        </div>

        <div class="mt-6 flex items-center justify-between">
          <h2 class="font-semibold">–õ–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏</h2>
          <button type="button"
                  class="text-sm px-3 py-1 rounded-md border border-slate-300 text-slate-700 hover:bg-slate-100"
                  @click="copyLog"
                  :disabled="!(log && log.length)">
            –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥
          </button>
        </div>
        <pre class="bg-slate-50 p-3 rounded-lg text-sm text-slate-700 min-h-[120px] whitespace-pre-wrap"
             x-ref="logBox"
             x-text="log || '–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ö–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞.'"></pre>
        <p class="text-green-700 mt-2" x-show="copied" x-transition>–õ–æ–≥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞</p>
        <p class="text-red-600 mt-2" x-text="error"></p>
      </form>
    </div>
  </div>

<script>
function ui(){
  return {
    files: [],
    token: '',
    reco_token: '',
    log: '',
    error: '',
    copied: false,
    onPick(e){
      if(e.target.files && e.target.files.length){
        this.addFiles(e.target.files);
        e.target.value = '';
      }
    },
    onDrop(ev){
      const dropped = [...ev.dataTransfer.files].filter(f => /\.(xlsx|csv)$/i.test(f.name));
      if(dropped.length){ this.addFiles(dropped); }
    },
    remove(idx){ this.files.splice(idx,1); },
    clearAll(){
      this.files = [];
      const input = document.getElementById('files');
      if(input){ input.value=''; }
      this.token=''; this.reco_token=''; this.log=''; this.error='';
    },
    addFiles(list){
      const incoming = Array.from(list);
      incoming.forEach(file => {
        const duplicate = this.files.some(existing => existing.name === file.name && existing.size === file.size && existing.lastModified === file.lastModified);
        if(!duplicate){ this.files.push(file); }
      });
    },
    formatName(file){
      const sizeKb = Math.max(1, Math.round(file.size / 1024));
      return `${file.name} ‚Äî ${sizeKb} –ö–ë`;
    },
    async build(){
      this.error=''; this.log=''; this.token='';
      if(!this.files.length){ this.error='–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–π–ª –æ—Ç—á—ë—Ç–∞.'; return; }
      const fd = new FormData();
      this.files.forEach(f=>fd.append('files', f));
      const res = await fetch('/build', { method:'POST', body: fd });
      const data = await res.json().catch(()=>({ok:false,log:'–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞'}));
      if(!res.ok || !data.ok){ this.error = data.log || '–û—à–∏–±–∫–∞'; return; }
      this.log = data.log; this.token = data.download_token; this.reco_token='';
      this.copied = false;
    },
    async recommend(){
      this.error=''; this.reco_token='';
      if(!this.files.length){ this.error='–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel-–∏–Ω–ø—É—Ç –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.'; return; }
      const fd = new FormData();
      fd.append('files', this.files[0]);
      const res = await fetch('/recommend', { method:'POST', body: fd });
      const data = await res.json().catch(()=>({ok:false,log:'–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞'}));
      if(!res.ok || !data.ok){ this.error = data.log || '–û—à–∏–±–∫–∞'; return; }
      this.log = (data.log ? data.log + '\n' : '') + (this.log || '');
      this.reco_token = data.download_token;
      this.copied = false;
    },
    async copyLog(){
      try{
        await navigator.clipboard.writeText(this.log || '');
        this.copied = true;
        setTimeout(()=> this.copied = false, 2000);
      }catch(e){
        this.error = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥';
      }
    }
  }
}
</script>
</body>
</html>
